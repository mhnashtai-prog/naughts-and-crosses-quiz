<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>INTUITY ‚Äì Naughts & Crosses (Enhanced Edition)</title>
<style>
:root{
  --bg:#060606; --muted:#dfeee0; --lime1:#9be56a; --lime2:#5dd26b; --glass:rgba(255,255,255,0.04);
  --blue1:#4a9eff; --blue2:#2563eb;
  --card-pad:18px; --accent-bezier:cubic-bezier(.4,0,.2,1);
  font-family: -apple-system, 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#050606 0%, #071113 100%);color:var(--muted);-webkit-font-smoothing:antialiased}
.container{max-width:980px;margin:22px auto;padding:18px;display:flex;flex-direction:column;gap:18px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.brand{display:flex;flex-direction:column}
.brand h1{margin:0;font-size:20px;color:whitesmoke;font-weight:600;letter-spacing:1px}
.brand .sub{font-size:12px;color:rgba(255,255,255,0.7)}
.brand .author{font-size:12px;color:rgba(255,255,255,0.45)}
.statusBar{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.player{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid rgba(255,255,255,0.03);transition:all 0.3s var(--accent-bezier)}
.player.active{border-color:rgba(255,255,255,0.15);box-shadow:0 0 20px rgba(155,229,106,0.2)}
.player .icon{font-size:18px}
.player .meta{font-size:13px}
.boardWrap{display:flex;flex-direction:column;align-items:center;gap:12px}
.board{width:460px;max-width:94vw;padding:18px;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.45));border:1px solid rgba(255,255,255,0.03);box-shadow:20px 30px 60px rgba(0,0,0,0.7);position:relative;transition:opacity 0.3s var(--accent-bezier)}
.boardHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.small{font-size:13px;color:rgba(255,255,255,0.7)}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.cell{aspect-ratio:1/1;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;cursor:pointer;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.3));border:1px solid rgba(255,255,255,0.03);transition:transform .25s var(--accent-bezier),box-shadow .18s;overflow:hidden}
.cell:before{content:'';position:absolute;inset:0;border-radius:12px;padding:2px;pointer-events:none;background:linear-gradient(90deg,transparent,transparent);}
.cell:hover:not(.claimed-X):not(.claimed-O){transform:translateY(-8px) rotateX(2deg);box-shadow:0 14px 30px rgba(0,0,0,0.6)}
.cell .label{position:absolute;top:10px;left:12px;font-size:12px;color:rgba(255,255,255,0.75);font-weight:500}
.cell .symbol{font-size:36px;transition:transform 0.3s var(--accent-bezier)}
.cell.claimed-X{background:linear-gradient(180deg,var(--blue1),var(--blue2));color:#ffffff;box-shadow:0 6px 20px rgba(74,158,255,0.3)}
.cell.claimed-O{background:linear-gradient(180deg,var(--lime1),var(--lime2));color:#04270b;box-shadow:0 6px 20px rgba(155,229,106,0.3)}
.cell.perfect{animation:perfectPulse 0.6s ease-out}
.cell.activeEdge{box-shadow:0 0 24px rgba(155,229,106,0.12);border:1px solid rgba(155,229,106,0.18)}
@keyframes perfectPulse{
  0%{transform:scale(1)}
  50%{transform:scale(1.08);box-shadow:0 10px 40px rgba(155,229,106,0.5)}
  100%{transform:scale(1)}
}
@keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-4px)}100%{transform:translateX(0)}}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:12px;z-index:60;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px)}
.modal.show{display:flex;animation:fadeIn 0.2s ease-out}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.panel{width:100%;max-width:520px;border-radius:12px;padding:20px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.5));border:1px solid rgba(255,255,255,0.04);box-shadow:0 30px 60px rgba(0,0,0,0.7);backdrop-filter:blur(6px);position:relative;overflow:hidden;animation:slideUp 0.3s var(--accent-bezier)}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.panelHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.panelBody{display:flex;flex-direction:column;gap:18px;max-height:60vh;overflow-y:auto;padding-right:8px}
.panelBody::-webkit-scrollbar{width:6px}
.panelBody::-webkit-scrollbar-track{background:rgba(255,255,255,0.02);border-radius:3px}
.panelBody::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px}
.q{margin-bottom:0}
.q h4{margin:0 0 12px 0;font-size:14px;color:rgba(255,255,255,0.90);font-weight:500;line-height:1.5}
.choices{display:flex;flex-wrap:wrap;gap:10px}
.matchContainer{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start}
.matchLeft{display:flex;flex-direction:column;gap:8px}
.matchRight{display:flex;flex-direction:column;gap:8px}
.choice{
  padding:12px 16px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.08);
  cursor:pointer;
  background:rgba(255,255,255,0.02);
  font-size:14px;
  color:rgba(255,255,255,0.85);
  transition:all .2s var(--accent-bezier);
  box-shadow:0 2px 8px rgba(255,140,40,0.08);
  min-height:44px;
  display:flex;
  align-items:center;
  justify-content:center;
  user-select:none;
}
.choice:hover{
  background:rgba(255,255,255,0.04);
  border-color:rgba(255,255,255,0.12);
  transform:translateY(-1px);
  box-shadow:0 4px 12px rgba(255,140,40,0.12);
}
.choice.selected{
  background:rgba(59,130,246,0.25);
  border-color:rgba(59,130,246,0.4);
  box-shadow:0 4px 16px rgba(59,130,246,0.3);
  color:rgba(255,255,255,0.95);
  transform:scale(1.02);
}
.choice.matched{
  background:rgba(155,229,106,0.15);
  border-color:rgba(155,229,106,0.3);
  opacity:0.7;
  pointer-events:none;
}
.choice.correct{
  background:linear-gradient(180deg,var(--lime1),var(--lime2));
  color:#04270b;
  border-color:var(--lime2);
  box-shadow:0 6px 20px rgba(155,229,106,0.35);
  animation:correctBounce 0.4s ease-out;
}
@keyframes correctBounce{
  0%{transform:scale(1)}
  50%{transform:scale(1.05)}
  100%{transform:scale(1)}
}
.choice.wrong{
  background:rgba(255,80,80,0.15);
  border-color:rgba(255,80,80,0.25);
  box-shadow:0 4px 12px rgba(255,80,80,0.2);
  animation:shake 0.3s ease-out;
}
.choice.input{
  width:100%;
  padding:14px 16px;
  color:var(--muted);
  font-size:15px;
}
.panelFooter{display:flex;justify-content:space-between;align-items:center;margin-top:16px;flex-wrap:wrap;gap:10px}
.btn{padding:10px 16px;border-radius:10px;border:0;cursor:pointer;font-size:14px;font-weight:500;transition:all .2s var(--accent-bezier)}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--muted)}
.btn.ghost:hover{background:rgba(255,255,255,0.04);border-color:rgba(255,255,255,0.12)}
.btn.primary{background:linear-gradient(180deg,var(--lime1),var(--lime2));color:#04270b}
.btn.primary:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(155,229,106,0.3)}
.btn.primary:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.svgOverlay{position:absolute;inset:0;pointer-events:none}
.line{stroke:var(--lime2);stroke-width:8;stroke-linecap:round;fill:none;stroke-dasharray:600;stroke-dashoffset:600;transition:stroke-dashoffset .9s var(--accent-bezier)}
.trophy{position:absolute;left:50%;top:30%;transform:translate(-50%,-50%) scale(0);opacity:0;transition:transform .6s var(--accent-bezier),opacity .4s}
.trophy.show{transform:translate(-50%,-50%) scale(1);opacity:1}
.trophy .cup{font-size:56px}
.board.hidden{opacity:0;pointer-events:none}
@media(max-width:900px){ 
  .panel{width:94vw;padding:18px} 
  .choice{padding:10px 14px;font-size:13px;min-height:42px}
  .q h4{font-size:13px}
  .matchContainer{grid-template-columns:1fr;gap:12px}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <h1>INTUITY</h1>
      <div class="sub">Intuitive & Immersive</div>
      <div class="author">Majid Nashtai</div>
    </div>
    <div class="statusBar">
      <div class="player" id="playerX"><div class="icon">‚úñ</div><div class="meta">Player X ‚Äì <strong id="scoreX">0</strong></div></div>
      <div class="player" id="playerO"><div class="icon">‚≠ï</div><div class="meta">Player O ‚Äì <strong id="scoreO">0</strong></div></div>
    </div>
  </div>

  <div class="boardWrap">
    <div class="board" id="board">
      <div class="boardHeader"><div class="small">Set: <strong id="setLabel">1</strong></div><div class="small">Turn: <strong id="turnLabel">X</strong></div></div>
      <div class="grid" id="grid"></div>
      <svg class="svgOverlay" viewBox="0 0 300 300" preserveAspectRatio="none"></svg>
      <div class="trophy" id="trophy"><div class="cup">üèÜ</div></div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap">
      <div id="dots"></div>
      <button class="btn ghost" id="resetBtn">Reset Game</button>
    </div>
  </div>
</div>

<div class="modal" id="modal">
  <div class="panel" role="dialog" aria-modal="true">
    <div class="panelHeader">
      <div>
        <div class="small" id="modalTopic">Topic</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.85)" id="modalSub">5 questions</div>
      </div>
    </div>
    <div class="panelBody" id="panelBody"></div>
    <div class="panelFooter">
      <div class="small" id="panelInfo">Select answers ‚Äì 100% awards tile</div>
      <div style="display:flex;gap:8px">
        <button class="btn ghost" id="closeBtn">Close</button>
        <button class="btn primary" id="submitBtn">Submit Answers</button>
      </div>
    </div>
  </div>
</div>
<script>
const SETS = 3;
const labels = [
  ['Music','English','Cities'],
  ['English','Countries','English'],
  ['Sport','English','Famous People']
];

const POOL = {
  'Music': [
    {type:'mcq',q:'Which band is from Liverpool?',opts:['Oasis','The Beatles','Coldplay'],a:1},
    {type:'mcq',q:'Who composed "F√ºr Elise"?',opts:['Mozart','Beethoven','Vivaldi'],a:1},
    {type:'mcq',q:'Tempo in music refers to?',opts:['Speed','Pitch','Volume'],a:0},
    {type:'mcq',q:'Which instrument family does the clarinet belong to?',opts:['Brass','Woodwind','String'],a:1},
    {type:'match',q:'Match instrument to family',pairs:[['Guitar','Strings'],['Trumpet','Brass'],['Flute','Woodwind']]}
  ],
  'Cities': [
    {type:'mcq',q:'What is the capital of France?',opts:['Paris','Rome','Berlin'],a:0},
    {type:'gap',q:'The capital of Portugal is ___',a:'Lisbon'},
    {type:'mcq',q:'"The Big Apple" refers to which city?',opts:['NYC','LA','Chicago'],a:0},
    {type:'mcq',q:'What is the capital of Japan?',opts:['Seoul','Tokyo','Beijing'],a:1},
    {type:'match',q:'Match city to country',pairs:[['Lisbon','Portugal'],['Tokyo','Japan'],['Paris','France']]}
  ],
  'Countries': [
    {type:'mcq',q:'Which is the largest country by area?',opts:['Canada','Russia','USA'],a:1},
    {type:'gap',q:'Madeira is an autonomous region of ___',a:'Portugal'},
    {type:'mcq',q:'Which country has the maple leaf on its flag?',opts:['Canada','USA','UK'],a:0},
    {type:'match',q:'Match country to continent',pairs:[['Brazil','South America'],['Italy','Europe'],['Australia','Oceania']]},
    {type:'mcq',q:'Canberra is the capital of which country?',opts:['Australia','Austria','Argentina'],a:0}
  ],
  'Sport': [
    {type:'mcq',q:'Which sport is played at Wimbledon?',opts:['Football','Tennis','Cricket'],a:1},
    {type:'gap',q:'In tennis, a score of zero is called ___',a:'Love'},
    {type:'mcq',q:'How many players are on a football (soccer) team?',opts:['9','10','11'],a:2},
    {type:'match',q:'Match sport to equipment',pairs:[['Tennis','Racket'],['Cricket','Bat'],['Football','Ball']]},
    {type:'mcq',q:'A shuttlecock is used in which sport?',opts:['Tennis','Badminton','Squash'],a:1}
  ],
  'Famous People': [
    {type:'mcq',q:'Who authored "Hamlet"?',opts:['Shakespeare','Homer','Dante'],a:0},
    {type:'gap',q:'The scientist famous for the theory of relativity: ___ Einstein',a:'Albert'},
    {type:'mcq',q:'Who painted the Mona Lisa?',opts:['Da Vinci','Van Gogh','Picasso'],a:0},
    {type:'match',q:'Match person to field',pairs:[['Churchill','Politics'],['Einstein','Science'],['Monet','Art']]},
    {type:'mcq',q:'Who was the first woman to fly solo across the Atlantic?',opts:['Amelia Earhart','Marie Curie','Rosa Parks'],a:0}
  ],
  'English_conditionals': [
    {type:'mcq',q:'If I ___ more time, I would have finished the project.',opts:['have had','had had','would have'],a:1},
    {type:'gap',q:'Were he to arrive early, we ___ start immediately. (can)',a:'could'},
    {type:'mcq',q:'She wouldn\'t have succeeded ___ she worked harder.',opts:['if','unless','provided'],a:1},
    {type:'mcq',q:'___ you pass the exam, you\'ll receive a certificate.',opts:['Should','Would','Could'],a:0},
    {type:'gap',q:'Had I known about the traffic, I ___ earlier. (leave)',a:'would have left'}
  ],
  'English_collocations': [
    {type:'gap',q:'Make a ___ decision (strong/definite)',a:'firm'},
    {type:'gap',q:'___ a conclusion (arrive at)',a:'draw'},
    {type:'mcq',q:'Which collocation is correct?',opts:['make homework','do homework','take homework'],a:1},
    {type:'gap',q:'Heavy ___ (not light precipitation)',a:'rain'},
    {type:'mcq',q:'The correct phrase is ___',opts:['pay attention','give attention','make attention'],a:0}
  ],
  'English_phrasal': [
    {type:'mcq',q:'The meeting was ___ until next week.',opts:['put off','put on','put up'],a:0},
    {type:'gap',q:'She needs to ___ with her studies. (continue diligently)',a:'keep up'},
    {type:'mcq',q:'I can\'t ___ his rudeness anymore.',opts:['put up with','put down to','put off'],a:0},
    {type:'gap',q:'The company had to ___ 50 employees. (dismiss)',a:'lay off'},
    {type:'mcq',q:'They\'re trying to ___ a solution.',opts:['come up with','come down with','come across'],a:0}
  ],
  'English_vocabulary': [
    {type:'mcq',q:'What does "ubiquitous" mean?',opts:['rare','present everywhere','ancient'],a:1},
    {type:'mcq',q:'"Brevity" refers to?',opts:['shortness','length','complexity'],a:0},
    {type:'mcq',q:'If someone is "elated", they are?',opts:['depressed','extremely happy','confused'],a:1},
    {type:'mcq',q:'"Candid" means?',opts:['honest and direct','shy','diplomatic'],a:0},
    {type:'mcq',q:'A "frugal" person is?',opts:['economical','wasteful','generous'],a:0}
  ]
};

let currentSet = 1;
let playerTurn = 'X';
let scores = JSON.parse(localStorage.getItem('intuity_scores')||'{}');
if(!scores.X){scores={X:0,O:0}}
let boardState = Array(9).fill(null);
let winsDrawn = false;
let matchingState = {firstClick: null, pairs: [], answered: false};

const grid = document.getElementById('grid');
for(let r=0;r<3;r++){
  for(let c=0;c<3;c++){
    const idx = r*3+c;
    const topic = labels[r][c];
    const cell = document.createElement('div');
    cell.className='cell';
    cell.dataset.index=idx;
    cell.dataset.topic=topic;
    const lab = document.createElement('div');
    lab.className='label';
    lab.textContent=topic;
    const sym = document.createElement('div');
    sym.className='symbol';
    sym.textContent='+';
    cell.appendChild(lab);
    cell.appendChild(sym);
    grid.appendChild(cell);
  }
}

const dotsEl = document.getElementById('dots');
for(let s=1;s<=SETS;s++){
  const d=document.createElement('button');
  d.className='btn ghost';
  d.textContent=`Set ${s}`;
  d.dataset.set=s;
  d.style.marginRight='6px';
  d.addEventListener('click',()=>switchSet(+d.dataset.set));
  dotsEl.appendChild(d);
}
updateSetLabel();
updatePlayerHighlight();

function switchSet(s){
  currentSet=s;
  updateSetLabel();
  clearForNewSet();
}

function updateSetLabel(){
  document.getElementById('setLabel').textContent=currentSet;
  dotsEl.querySelectorAll('.btn').forEach(b=>{
    b.style.borderColor = +b.dataset.set===currentSet ? 'rgba(155,229,106,0.4)' : 'rgba(255,255,255,0.08)';
  });
}

function updatePlayerHighlight(){
  document.getElementById('playerX').classList.toggle('active', playerTurn==='X');
  document.getElementById('playerO').classList.toggle('active', playerTurn==='O');
}

function clearForNewSet(){
  boardState = Array(9).fill(null);
  winsDrawn=false;
  document.querySelector('.svgOverlay').innerHTML='';
  renderBoard();
}

const modal = document.getElementById('modal');
const panelBody = document.getElementById('panelBody');
const modalTopic = document.getElementById('modalTopic');
let activeIndex = null;

function openModal(index){
  if(boardState[index] && boardState[index].perfect) return;
  activeIndex=index;
  matchingState = {firstClick: null, pairs: [], answered: false};
  const topic = labels[Math.floor(index/3)][index%3];
  modalTopic.textContent = topic;
  renderQuestions(topic,index);
  modal.classList.add('show');
  document.getElementById('board').classList.add('hidden');
  const cell = document.querySelector(`.cell[data-index='${index}']`);
  cell.classList.add('activeEdge');
}

function closeModal(){
  modal.classList.remove('show');
  document.getElementById('board').classList.remove('hidden');
  if(activeIndex!==null){
    const cell = document.querySelector(`.cell[data-index='${activeIndex}']`);
    cell.classList.remove('activeEdge');
  }
  activeIndex=null;
  matchingState = {firstClick: null, pairs: [], answered: false};
}

document.getElementById('closeBtn').addEventListener('click',()=>{
  closeModal();
});

function renderQuestions(topic,index){
  panelBody.innerHTML='';
  const key = topic==='English'? englishVariant(index) : topic;
  const qset = POOL[key]||[];
  qset.forEach((q,i)=>{
    const qdiv=document.createElement('div');
    qdiv.className='q';
    qdiv.dataset.qindex=i;
    const h=document.createElement('h4');
    h.textContent = `Q${i+1}. ${q.q}`;
    qdiv.appendChild(h);
    
    if(q.type==='mcq'){
      const ch=document.createElement('div');
      ch.className='choices';
      q.opts.forEach((opt,oi)=>{
        const b=document.createElement('button');
        b.className='choice';
        b.textContent=opt;
        b.dataset.sel=oi;
        b.addEventListener('click',()=>onSelectChoice(b,q,i));
        ch.appendChild(b);
      });
      qdiv.appendChild(ch);
    } else if(q.type==='gap'){
      const inp=document.createElement('input');
      inp.className='choice input';
      inp.placeholder='Type your answer here';
      inp.addEventListener('input',()=>onTextInput(inp,q));
      qdiv.appendChild(inp);
    } else if(q.type==='match'){
      const container=document.createElement('div');
      container.className='matchContainer';
      
      const left = document.createElement('div');
      left.className='matchLeft';
      q.pairs.forEach((p,pi)=>{
        const item=document.createElement('button');
        item.className='choice';
        item.textContent=`${pi+1}. ${p[0]}`;
        item.dataset.value=p[0];
        item.dataset.side='left';
        item.dataset.leftindex=pi;
        item.addEventListener('click',()=>onMatchClick(item,qdiv,q));
        left.appendChild(item);
      });
      
      const right=document.createElement('div');
      right.className='matchRight';
      const shuffled = q.pairs.slice().sort(()=>0.5-Math.random());
      shuffled.forEach((p,pi)=>{
        const b=document.createElement('button');
        b.className='choice';
        b.textContent=p[1];
        b.dataset.value=p[1];
        b.dataset.side='right';
        b.dataset.rightindex=pi;
        b.addEventListener('click',()=>onMatchClick(b,qdiv,q));
        right.appendChild(b);
      });
      
      container.appendChild(left);
      container.appendChild(right);
      qdiv.appendChild(container);
    }
    panelBody.appendChild(qdiv);
  });
}

function englishVariant(index){
  const engTypes=['English_conditionals','English_collocations','English_phrasal','English_vocabulary'];
  const engPositions=[];
  labels.flat().forEach((lab,i)=>{
    if(lab==='English') engPositions.push(i);
  });
  const pi = engPositions.indexOf(index);
  return engTypes[pi % engTypes.length];
}

function onSelectChoice(btn,q,i){
  const parent = btn.parentElement;
  parent.querySelectorAll('.choice').forEach(x=>x.classList.remove('selected'));
  btn.classList.add('selected');
  btn.closest('.q').dataset.selected = btn.dataset.sel;
}

function onTextInput(inp,q){
  // Just allow typing
}

function onMatchClick(btn, qdiv, q){
  if(btn.classList.contains('matched')) return;
  
  if(!matchingState.firstClick){
    // First click - select any item
    btn.classList.add('selected');
    matchingState.firstClick = btn;
  } else if(btn === matchingState.firstClick){
    // Clicking same button - deselect
    btn.classList.remove('selected');
    matchingState.firstClick = null;
  } else if(btn.dataset.side === matchingState.firstClick.dataset.side){
    // Clicking another item on the same side - switch selection
    matchingState.firstClick.classList.remove('selected');
    btn.classList.add('selected');
    matchingState.firstClick = btn;
  } else {
    // Second click on opposite side - create pair
    const first = matchingState.firstClick;
    const second = btn;
    
    first.classList.remove('selected');
    first.classList.add('matched');
    second.classList.add('matched');
    
    matchingState.pairs.push([first.dataset.value, second.dataset.value]);
    matchingState.firstClick = null;
    
    // Store pairs in qdiv
    qdiv.dataset.pairs = JSON.stringify(matchingState.pairs);
  }
}

document.getElementById('submitBtn').addEventListener('click',submitAnswers);

function submitAnswers(){
  if(activeIndex===null) return;
  const topic = labels[Math.floor(activeIndex/3)][activeIndex%3];
  const key = topic==='English'? englishVariant(activeIndex) : topic;
  const qset = POOL[key] || [];
  const qDivs = Array.from(panelBody.querySelectorAll('.q'));
  let correctCount=0;
  
  qset.forEach((q,i)=>{
    const qdiv = qDivs[i];
    if(!qdiv) return;
    
    if(q.type==='mcq'){
      const sel = qdiv.querySelector('.choice.selected');
      if(sel && Number(sel.dataset.sel)===q.a){
        correctCount++;
        sel.classList.add('correct');
      } else {
        if(sel) sel.classList.add('wrong');
        const all = qdiv.querySelectorAll('.choice');
        all.forEach(ch=>{
          if(Number(ch.dataset.sel)===q.a) ch.classList.add('correct');
        });
      }
    } else if(q.type==='gap'){
      const inp = qdiv.querySelector('input');
      const val = inp.value.trim().toLowerCase().replace(/\s+/g, ' ');
      const answer = String(q.a).toLowerCase().trim();
      if(val===answer){
        correctCount++;
        inp.classList.add('correct');
      } else {
        inp.classList.add('wrong');
      }
    } else if(q.type==='match'){
      const pairs = JSON.parse(qdiv.dataset.pairs || '[]');
      let allCorrect = true;
      
      if(pairs.length !== q.pairs.length){
        allCorrect = false;
      } else {
        // Check if all pairs match
        pairs.forEach(userPair => {
          const found = q.pairs.some(correctPair => 
            userPair.includes(correctPair[0]) && userPair.includes(correctPair[1])
          );
          if(!found) allCorrect = false;
        });
      }
      
      const choices = qdiv.querySelectorAll('.choice');
      if(allCorrect){
        correctCount++;
        choices.forEach(ch => ch.classList.add('correct'));
      } else {
        choices.forEach(ch => {
          if(ch.classList.contains('matched')){
            ch.classList.add('wrong');
          }
        });
      }
    }
  });
  
  const perfect = correctCount===qset.length;
  if(perfect){
    awardTile(activeIndex);
  }
  
  setTimeout(()=>{
    clearPanelVisuals();
    closeModal();
    if(perfect) flashCellPerfect(activeIndex);
  },1800);
}

function clearPanelVisuals(){
  panelBody.querySelectorAll('.q').forEach(q=>{
    q.querySelectorAll('.choice').forEach(ch=>{
      ch.classList.remove('wrong','correct','selected','matched');
    });
    const inp = q.querySelector('input');
    if(inp) {
      inp.classList.remove('wrong','correct');
      inp.value='';
    }
    q.dataset.pairs = '';
  });
  matchingState = {firstClick: null, pairs: [], answered: false};
}

function flashCellPerfect(idx){
  const cell = document.querySelector(`.cell[data-index='${idx}']`);
  cell.classList.add('perfect');
  setTimeout(()=>cell.classList.remove('perfect'),600);
}

function awardTile(idx){
  boardState[idx]={owner:playerTurn,perfect:true};
  renderBoard();
  scores[playerTurn] = (scores[playerTurn]||0)+1;
  document.getElementById(playerTurn==='X'?'scoreX':'scoreO').textContent = scores[playerTurn];
  localStorage.setItem('intuity_scores', JSON.stringify(scores));
  playCorrect();
  checkWin();
  playerTurn = playerTurn==='X'?'O':'X';
  document.getElementById('turnLabel').textContent = playerTurn;
  updatePlayerHighlight();
}

function renderBoard(){
  document.querySelectorAll('.cell').forEach((cell,i)=>{
    const s=boardState[i];
    const sym=cell.querySelector('.symbol');
    cell.classList.remove('claimed-X','claimed-O');
    if(s){
      cell.classList.add('claimed-'+s.owner);
      sym.textContent = s.owner==='X'? '‚úñ' : '‚≠ï';
    } else {
      sym.textContent='+';
    }
  });
}

const WINS = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];

function checkWin(){
  const owners = boardState.map(v=>v? v.owner : null);
  for(const line of WINS){
    if(line.every(i=>owners[i]===owners[line[0]] && owners[i]!==null)){
      drawLine(line);
      showTrophy();
      break;
    }
  }
}

function drawLine(line){
  const svg = document.querySelector('.svgOverlay');
  svg.innerHTML='';
  const cells = Array.from(document.querySelectorAll('.cell'));
  const p1 = centerOf(cells[line[0]]);
  const p3 = centerOf(cells[line[2]]);
  const gridRect = grid.getBoundingClientRect();
  const scaleX = 300 / gridRect.width;
  const scaleY = 300 / gridRect.height;
  const x1=(p1.x-gridRect.left)*scaleX;
  const y1=(p1.y-gridRect.top)*scaleY;
  const x2=(p3.x-gridRect.left)*scaleX;
  const y2=(p3.y-gridRect.top)*scaleY;
  const ln=document.createElementNS('http://www.w3.org/2000/svg','line');
  ln.setAttribute('x1',x1);
  ln.setAttribute('y1',y1);
  ln.setAttribute('x2',x2);
  ln.setAttribute('y2',y2);
  ln.classList.add('line');
  svg.appendChild(ln);
  setTimeout(()=>ln.style.strokeDashoffset='0',60);
  winsDrawn=true;
}

function centerOf(el){
  const r=el.getBoundingClientRect();
  return {x:(r.left+r.right)/2,y:(r.top+r.bottom)/2};
}

function showTrophy(){
  const t=document.getElementById('trophy');
  t.classList.add('show');
  playWin();
  setTimeout(()=>t.classList.remove('show'),3800);
}

document.getElementById('resetBtn').addEventListener('click',()=>{
  boardState=Array(9).fill(null);
  playerTurn='X';
  scores={X:0,O:0};
  localStorage.setItem('intuity_scores',JSON.stringify(scores));
  document.getElementById('scoreX').textContent='0';
  document.getElementById('scoreO').textContent='0';
  document.getElementById('turnLabel').textContent='X';
  document.querySelector('.svgOverlay').innerHTML='';
  updatePlayerHighlight();
  renderBoard();
});

const audioCtx = (window.AudioContext||window.webkitAudioContext)? new (window.AudioContext||window.webkitAudioContext)():null;

function playTone(freq,dur){
  if(!audioCtx) return;
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.type='sine';
  o.frequency.value=freq;
  g.gain.value=0.02;
  o.connect(g);
  g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime+dur);
}

function playCorrect(){
  playTone(1100,0.09);
  setTimeout(()=>playTone(1300,0.09),100);
}

function playWin(){
  playTone(1200,0.12);
  setTimeout(()=>playTone(1400,0.12),140);
  setTimeout(()=>playTone(1600,0.15),280);
}

function vibrate(ms){
  if(navigator.vibrate) navigator.vibrate(ms);
}

document.querySelectorAll('.cell').forEach(c=>c.addEventListener('click',()=>{
  const idx = +c.dataset.index;
  if(boardState[idx] && boardState[idx].perfect) return;
  vibrate(10);
  playTone(800,0.03);
  openModal(idx);
}));

window.__INTUITY = {boardState, scores, reset:()=>document.getElementById('resetBtn').click()};

renderBoard();
document.getElementById('scoreX').textContent = scores.X;
document.getElementById('scoreO').textContent = scores.O;
</script>
</body>
</html>
